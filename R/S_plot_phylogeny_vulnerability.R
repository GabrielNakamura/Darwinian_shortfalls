
# reading libraries and data ----------------------------------------------

library(ape)
library(picante)
library(phytools)
library(ggplot2)
library(ggtree)
library(ggtreeExtra)
library(here)
library(dplyr)

# data
phy <- readRDS(here("output", "tree_graft_final.rds"))
ed_all <- read.table(here("data", "aed.txt"))
df_ed_all <- data.frame(species = rownames(ed_all), vulnerability = ed_all$vuln_final.Vulnerability)
insertion <- readRDS(here::here("output", "data_insertion.rds"))


# adjusting the order of insertions
insertion$insertion <- factor(insertion$insertion, 
                               levels = c("present in tree", 
                                          "genus_insertion",
                                          "family_insertion", 
                                          "order_insertion")
)
df_insertion <- insertion
df_ed_org <- df_ed_all[match(df_ed_all$species, df_insertion$s), ]
df_ed_org <- df_ed_org[-which(is.na(df_ed_org$species) == TRUE), ]
colnames(df_ed_org)[1] <- "s"
# removing species with no info on ed
# phy$tip.label[phy$tip.label %in% df_ed_org$s]
# phy_org <- keep.tip(phy = phy, tip = df_ed_org$s)

df_insert_aed <- 
df_ed_org %>% 
  left_join(insertion, by = "s")

# plotting tree -----------------------------------------------------------

p.base <- ggtree(phy_org, layout = "circular", size = .3)  %<+% insertions_org +
  geom_treescale(x = 0, width = 20, linesize = .5, color = "blue", 
                 fontsize = 0) + #  plot the scale bar
  annotate("text", x = 4, y = 500, label = "20 myr", size = 1.5) # an attempt for add a scale bar

p.full <- p.base +
  geom_tippoint(aes(color = insertions), 
                size = .5, alpha = .8) +
  theme(legend.position = "bottom") +
  guides(color = guide_legend(override.aes = list(size = 2)))  +
  scale_color_viridis_d(name = NULL, na.translate = F,
                        labels = c("Congeneric F", "Congeneric", "Family", "Order", "Present")) 



tree_aes <- 
ggtree(phy, layout = "circular") +
  geom_fruit(data = df_insert_aed, 
             geom = geom_bar, 
             mapping = aes(y = s, x = vulnerability), 
             pwidth = 0.3, orientation="y", stat="identity")
  
tree_aes <- 
  ggtree(phy_org, layout = "circular") +
  geom_fruit(data = df_insert_aed, 
             geom = geom_bar, 
             mapping = aes(y = s, x = vulnerability, fill = insertion), 
             pwidth=0.3, orientation="y", stat="identity") +
  scale_fill_viridis_d() +
  theme(legend.position = "bottom")


                     
ggsave(filename = here::here("output", "images", "tree_aed.pdf"), 
       plot = tree_aes,
       device = "pdf",
       dpi = 300, 
       width = 10, 
       height = 10)

ggsave(filename = here::here("output", "images", "tree_aed.png"), 
       plot = tree_aes,
       device = "png",
       dpi = 300, 
       width = 10, 
       height = 10)



# collapsing tips to orders -----------------------------------------------

data_insertion_clean <- data_insertion[which(data_insertion$s %in% tree_update_order$tip.label == TRUE), ]
sub_order <- lapply(unique(data_insertion_clean$o), function(x) subset(data_insertion_clean, o == x))


position_order <- 
  lapply(sub_order, function(x){
    node_anc <- ape::getMRCA(phy = phy, tip = x$s)
  })


df.phylo <- data.frame(Ord.names = unique(data_insertion_clean$o)[-35],
                       node.number = unlist(position_order)) # Amiiformes monotipic order removed 
library(ggtree)
library(ggplot2)
library(viridisLite)
library(viridis)

plot.base <- 
  ggtree(phy) +
  theme_tree2()

plot.base +
  geom_hilight(data = df.phylo[1:3,], aes(node = node.number, fill = Ord.names), 
                     alpha = .6) +
  scale_fill_viridis(discrete = T, name = "Order names")


match(extract.clade(phy, node = df.phylo[1, "node.number"])$tip.label, sub_order[[1]]$s)
extract.clade(phy, node = df.phylo[1, "node.number"])$tip.label[1:8]
sort(table(insertion$f))
which(insertion$o == "")
extract.clade(phy = phy, node = findMRCA(tree = phy, tips = which(insertion$f == "Berycidae"))) 
library(ggtree)
tree_test <- ggtree::groupOTU(phy, insertion[which(insertion$f == "Zoarcidae"), "s"])
tree2 <- ggtree(tree_test, aes(color=group))
findMRCA(tree = tree, tips = which(insertion$f == "Zoarcidae"))
viewClade(tree2, 100 + 32851)
table(insertion$f)
